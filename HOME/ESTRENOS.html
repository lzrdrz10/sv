<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estrenos 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Poppins", sans-serif;
    }

    /* Loader */
    #loader {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #04143b;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    #loader.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .spinner {
      border: 5px solid rgba(255, 255, 255, 0.2);
      border-top: 5px solid #4a7fff;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }

    #progress {
      font-size: 1rem;
      font-weight: 600;
      color: #4a7fff;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PC9JETB0VP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PC9JETB0VP');
</script>
</head>

<body class="bg-[#04143B] text-white min-h-screen">
  <!-- Loader con contador -->
  <div id="loader">
    <div class="spinner"></div>
    <div id="progress">0%</div>
  </div>

  <!-- Header -->
  <header class="fixed top-0 left-0 w-full z-50 bg-[#04143B] flex flex-col md:flex-row items-center justify-between px-4 py-3 max-w-[1280px] mx-auto shadow-md">
    <div class="flex items-center space-x-4 w-full md:w-auto justify-between">
      <div class="flex flex-row items-center space-x-3">
        <button onclick="history.back()" class="bg-[#0D1B4C] rounded-full px-4 py-1.5 text-sm font-semibold text-[#4A7FFF] flex items-center space-x-1">
          <i class="fas fa-arrow-left"></i><span>Atrás</span>
        </button>
        <h1 class="text-2xl font-extrabold text-[#4A7FFF] select-none">
         2025 <span id="contadorPublicaciones" class="text-sm font-normal text-white/70 ml-2">(0)</span>
        </h1>
      </div>

      <a href="../../SEARCH/" id="btnBuscar" class="md:hidden flex items-center justify-center w-10 h-10 rounded-full border-2 border-white shadow-md">
        <i class="fas fa-search"></i>
      </a>
    </div>

    <nav class="hidden md:flex items-center space-x-6 text-sm font-semibold text-white/90 mt-2 md:mt-0">
      <a href="../../" class="flex items-center space-x-1 hover:text-[#4A7FFF]"><i class="fas fa-home"></i><span>Inicio</span></a>
      <a href="../movie" class="hover:text-[#4A7FFF]">Películas</a>
      <a href="../serie" class="hover:text-[#4A7FFF]">Series</a>
    </nav>

    <a href="../../SEARCH/index.html" id="btnBuscarDesktop" class="hidden md:flex items-center justify-center w-12 h-12 rounded-full border-2 border-white shadow-md ml-4">
      <i class="fas fa-search"></i>
    </a>
  </header>

  <!-- Main -->
  <main id="mainContainer" class="max-w-[1280px] mx-auto px-4 mt-24 overflow-hidden">
    <section id="content-section" 
      class="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-4 transition-all duration-300">
    </section>

    <div class="flex justify-center items-center space-x-4 mt-10 mb-10">
      <button id="prev" class="bg-[#0D1B4C] px-4 py-2 rounded-lg font-semibold text-[#4A7FFF] disabled:opacity-40 transition">Anterior</button>
      <button id="next" class="bg-[#0D1B4C] px-4 py-2 rounded-lg font-semibold text-[#4A7FFF] transition">Siguiente</button>
    </div>
  </main>

  <script>
(function(_0x1f4b3a,_0x2e5c1d){var _0x4c3e2b=function(_0x5a3f1c){while(--_0x5a3f1c){_0x1f4b3a['push'](_0x1f4b3a['shift']());}};var _0x3b2f4e=function(){var _0x1a3e5f={'data':function(_0x4e2c1b,_0x3f5a2d){return _0x4e2c1b!==_0x3f5a2d;},'action':function(){return'atob';},'value':function(){return'VXNlckx6UGxheQ==';},'store':function(){return'localStorage';},'redirect':function(){return'https://dlz.blogdepelis.lat/';},'message':function(){return'Acceso no permitido. Descarga la aplicacion oficial';},'isSafari':function(){return /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);}};return _0x1a3e5f;}();_0x4c3e2b(0x1f4);var _0x5e3d2a=_0x3b2f4e;document['addEventListener']('DOMContentLoaded',function(){if(!_0x5e3d2a['isSafari']()){var _0x2d4f1c=_0x5e3d2a['store']();var _0x4b3e2f=window[_0x2d4f1c]['getItem']('accessToken');if(!_0x4b3e2f || _0x5e3d2a['data'](_0x4b3e2f,_0x5e3d2a['action']()(_0x5e3d2a['value']()))){alert(_0x5e3d2a['message']());window['location']['href']=_0x5e3d2a['redirect']();}window[_0x2d4f1c]['removeItem']('accessToken');}});})(['push','shift'],0x1f4);

    const GITHUB_API = "https://api.github.com/repos/lzrdrz10/sv/contents/";
    const GITHUB_RAW = "https://raw.githubusercontent.com/lzrdrz10/sv/main/";
    const LOCAL_JSON_KEY = "estrenos2025";

    const loader = document.getElementById("loader");
    const progress = document.getElementById("progress");
    const contador = document.getElementById("contadorPublicaciones");
    const contentSection = document.getElementById("content-section");
    const mainContainer = document.getElementById("mainContainer");

    let estrenos = [];
    let currentPage = 1;
    const itemsPerPage = 15;

    async function fetchFileContentRaw(filePath) {
      try {
        const res = await fetch(GITHUB_RAW + filePath);
        if (!res.ok) return null;
        const html = await res.text();
        const parser = new DOMParser();
        return parser.parseFromString(html, "text/html");
      } catch (e) { console.error("Error fetching file:", filePath, e); return null; }
    }

    async function fetchFileList(folder) {
      try {
        const res = await fetch(GITHUB_API + folder);
        if (!res.ok) throw new Error(`Failed to fetch ${folder} contents`);
        const files = await res.json();
        return files.filter(file => file.name.endsWith(".html")).map(file => `${folder}/${file.name}`);
      } catch (e) { console.error(`Error fetching file list for ${folder}:`, e); return []; }
    }

    async function buscarEstrenos() {
      showLoader();
      const startTime = performance.now();
      estrenos = JSON.parse(localStorage.getItem(LOCAL_JSON_KEY) || "[]");

      const folder = "Peliculas";
      const files = await fetchFileList(folder);
      const archivosNuevos = files.filter(f => !estrenos.some(e => e.url === f));

      const totalSteps = archivosNuevos.length || 1;
      let loadedSteps = 0;

      if (archivosNuevos.length > 0) {
        const docs = [];
        for (const f of archivosNuevos) {
          const doc = await fetchFileContentRaw(f);
          loadedSteps++;
          updateProgress((loadedSteps / totalSteps) * 90);
          docs.push(doc);
        }

        docs.forEach((doc, i) => {
          if (!doc) return;
          const spans = [...doc.querySelectorAll("span")];
          const año = spans.find(s => /\d{4}/.test(s.textContent))?.textContent || "";
          if (spans.some(s => s.textContent.includes("2025") || s.textContent.includes("Año: 2025"))) {
            const titulo = doc.querySelector("h1,h2,h3")?.textContent.trim() || archivosNuevos[i].split("/").pop();
            const poster = doc.querySelector("img")?.src || "https://via.placeholder.com/300x450?text=No+Image";
            estrenos.push({ tipo: "Movie", titulo, url: archivosNuevos[i], año, poster });
          }
        });
        localStorage.setItem(LOCAL_JSON_KEY, JSON.stringify(estrenos));
      }

      shuffleArray(estrenos);
      await renderPage();
      updateProgress(100);

      const endTime = performance.now();
      const totalTime = ((endTime - startTime) / 1000).toFixed(2);
      console.log(`⏱️ Tiempo de carga inicial: ${totalTime}s`);
      hideLoader();
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    async function renderPage() {
      const start = performance.now();
      contentSection.innerHTML = "";
      const startIndex = (currentPage - 1) * itemsPerPage;
      const end = startIndex + itemsPerPage;
      const pageItems = estrenos.slice(startIndex, end);

      if (pageItems.length === 0) {
        contentSection.innerHTML = `<div class="col-span-full text-center text-white/70 py-8"><p>No se encontraron estrenos para 2025.</p></div>`;
      } else {
        for (const e of pageItems) {
          const article = document.createElement("article");
          article.className = "relative cursor-pointer select-none";
          article.innerHTML = `
            <a href="../../${e.url}" class="block bg-[#0D1B4C] rounded-lg overflow-hidden shadow-md hover:shadow-xl transition">
              <div class="aspect-[2/3] w-full overflow-hidden">
                <img src="${e.poster}" alt="${e.titulo}" loading="lazy" class="w-full h-full object-cover transition-transform duration-300 hover:scale-105"/>
              </div>
              <div class="p-1 sm:p-2">
                <div class="font-semibold text-xs sm:text-sm leading-tight truncate">${e.titulo}</div>
                <div class="text-[10px] sm:text-xs text-white/70">${e.año}</div>
              </div>
            </a>
          `;
          contentSection.appendChild(article);
        }
      }

      contador.textContent = `(${estrenos.length})`;

      const endTime = performance.now();
      const duration = endTime - start;
      return duration; // retorna cuánto tardó
    }

    // ---- Loader con progreso real ----
    let progressValue = 0;
    let progressRAF;

    function showLoader() {
      loader.classList.remove("fade-out");
      loader.style.display = "flex";
      progressValue = 0;
      progress.textContent = "0%";
    }

    function updateProgress(value) {
      progressValue = Math.min(value, 100);
      progress.textContent = Math.floor(progressValue) + "%";
    }

    function hideLoader() {
      updateProgress(100);
      setTimeout(() => {
        loader.classList.add("fade-out");
        setTimeout(() => loader.style.display = "none", 500);
      }, 300);
    }

    // ---- Paginación con tiempo de carga medido ----
    document.getElementById("prev").addEventListener("click", async () => {
      if (currentPage > 1) {
        showLoader();
        const start = performance.now();
        currentPage--;

        const duration = await renderPage();
        const end = performance.now();
        const total = (end - start + duration);
        animateProgress(total);
      }
    });

    document.getElementById("next").addEventListener("click", async () => {
      if ((currentPage * itemsPerPage) < estrenos.length) {
        showLoader();
        const start = performance.now();
        currentPage++;

        const duration = await renderPage();
        const end = performance.now();
        const total = (end - start + duration);
        animateProgress(total);
      }
    });

    // Simula el progreso del loader con base en la duración real
    function animateProgress(duration) {
      const startTime = performance.now();

      function frame(now) {
        const elapsed = now - startTime;
        const percent = Math.min((elapsed / duration) * 100, 100);
        updateProgress(percent);
        if (percent < 100) {
          progressRAF = requestAnimationFrame(frame);
        } else {
          cancelAnimationFrame(progressRAF);
          hideLoader();
          console.log(`⏱️ Tiempo de carga de página: ${(duration / 1000).toFixed(2)}s`);
        }
      }
      requestAnimationFrame(frame);
    }

    buscarEstrenos();
  </script>
</body>
</html>
