<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Panel Publicador AutoGit</title>
<style>
  body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#0d0d0d;color:#e0ffe0;padding:20px;margin:0}
  h2{text-align:center;color:#00ff7f;text-shadow:0 0 10px #00ff7f;}
  input,button{width:100%;padding:12px;margin-top:10px;background:#111;color:#fff;border:1px solid #00ff7f;border-radius:10px}
  button{cursor:pointer;font-weight:bold;background:linear-gradient(90deg,#00ff7f,#00cc66);color:#0d0d0d;}
  button:hover{transform:scale(1.05)}
  #resultados{margin-top:15px;display:flex;flex-wrap:wrap;gap:15px}
  .item{width:120px;cursor:pointer;background:#111;border-radius:12px;overflow:hidden;text-align:center;box-shadow:0 0 5px #00ff7f}
  .item img{width:100%;border-bottom:1px solid #00ff7f}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:999}
  .modal-content{background:#111;padding:20px;border-radius:10px;width:95%;max-width:420px}
</style>
</head>
<body>

<h2>Publicador TMDB + GitHub automátic</h2>
<input type="text" id="buscador" placeholder="Buscar película o serie...">
<div id="resultados"></div>

<div id="modal" class="modal">
  <div class="modal-content">
    <h3 id="modal-titulo">Título</h3>
    <input id="videoLink" placeholder="Pega el enlace de video">
    <button id="publicar">Publicar</button>
    <button onclick="cerrarModal()">Cancelar</button>
  </div>
</div>

<script>
// ------- CONFIG ------- //
var TMDB_API_KEY = "38e497c6c1a043d1341416e80915669f";
var GITHUB_TOKEN = "AQUI_PONES_TU_TOKEN";
var USUARIO = "lzrdrz10";
var REPO = "sv";
// ---------------------- //

var seleccionado = {};
document.getElementById("buscador").addEventListener("input",function(){
  var q=this.value.trim();
  if(!q){document.getElementById("resultados").innerHTML="";return;}
  fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&language=es-MX&query=${encodeURIComponent(q)}`)
  .then(r=>r.json()).then(d=>{
    var html="";
    (d.results||[]).forEach(p=>{
      if(p.media_type==="movie"||p.media_type==="tv"){
        let poster = p.poster_path ? "https://image.tmdb.org/t/p/w500"+p.poster_path : "";
        html+=`<div class="item" onclick="abrirModal(${p.id},'${p.media_type}')">
                 <img src="${poster}">
                 <div>${p.title||p.name}</div>
               </div>`;
      }
    });
    document.getElementById("resultados").innerHTML = html;
  });
});

function abrirModal(id,tipo){
  fetch(`https://api.themoviedb.org/3/${tipo}/${id}?api_key=${TMDB_API_KEY}&language=es-MX`)
  .then(r=>r.json()).then(p=>{
    seleccionado = {
      id, tipo,
      titulo: p.title || p.name,
      poster: "https://image.tmdb.org/t/p/original"+p.poster_path,
      backdrop: "https://image.tmdb.org/t/p/original"+p.backdrop_path,
      year: (p.release_date||p.first_air_date||"").split("-")[0],
      sinopsis: p.overview||"",
      duracion: p.runtime||"",
      director: (p.credits&&p.credits.crew||[]).filter(c=>c.job==="Director").map(c=>c.name).join(","),
      actores: (p.credits&&p.credits.cast||[]).slice(0,5).map(c=>c.name).join(","),
      generos: (p.genres||[]).map(g=>g.name)
    };
    document.getElementById("modal-titulo").innerText = seleccionado.titulo;
    document.getElementById("videoLink").value="";
    document.getElementById("modal").style.display="flex";
  });
}

function cerrarModal(){document.getElementById("modal").style.display="none";}

// Generar HTML usando tu plantilla base:
function plantilla(o,video){
return `<!DOCTYPE html>
<html lang="es"><head><meta charset="UTF-8"/><title>${o.titulo}</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>body{font-family:'Inter',sans-serif}</style></head>
<body class="relative min-h-screen overflow-x-hidden">
<div class="absolute inset-0"><img src="${o.backdrop}" class="w-full h-full object-cover"/><div class="absolute inset-0 bg-black bg-opacity-70"></div></div>
<div class="relative max-w-[1280px] mx-auto px-4 py-6">
<div class="flex flex-col lg:flex-row gap-6 lg:gap-10">
<div class="flex-shrink-0 mx-auto lg:mx-0 rounded-xl overflow-hidden w-[200px] sm:w-[240px] md:w-[280px] lg:w-[320px]"><img src="${o.poster}" alt="${o.titulo}" class="w-full h-auto object-cover"/></div>
<div class="flex-1 text-center lg:text-left">
<h1 class="text-white font-extrabold text-3xl md:text-4xl mb-2">${o.titulo}</h1>
<div class="flex flex-wrap justify-center lg:justify-start items-center text-gray-300 text-sm md:text-base space-x-3 mb-3">
<time>${o.year}</time><span>|</span><span>${o.duracion} min</span></div>
<div>${o.generos.map(g=>`<span class="inline-block border border-gray-500 rounded-full px-3 py-1 text-gray-300 text-xs md:text-sm mb-4">${g}</span>`).join("")}</div>
<button class="bg-[#e50914] rounded-md px-6 py-3 text-white font-semibold flex items-center gap-2 mx-auto lg:mx-0">
<a href="${video}"><i class="fas fa-play"></i> Ver ahora</a></button>
<p class="text-gray-300 text-sm md:text-base mb-6 max-w-xl mx-auto lg:mx-0">${o.sinopsis}</p>
</div></div></div></body></html>`;
}

async function crearArchivoGit(path, contenido){
  let data = await fetch(`https://api.github.com/repos/${USUARIO}/${REPO}/contents/${path}`,{
    method:"PUT",
    headers:{
      "Authorization":"token "+GITHUB_TOKEN,
      "Content-Type":"application/json"
    },
    body: JSON.stringify({
      message: "Auto subida contenido",
      content: btoa(unescape(encodeURIComponent(contenido)))
    })
  }).then(r=>r.json());
  return data;
}

document.getElementById("publicar").addEventListener("click", async function(){
  var video=document.getElementById("videoLink").value.trim();
  if(!video) return alert("Pega el enlace de video");
  
  var html = plantilla(seleccionado, video);

  // Obtenemos contador actual leyendo la carpeta general:
  let tipoFolder = seleccionado.tipo==="movie"?"Peliculas":"Series";
  let lista = await fetch(`https://api.github.com/repos/${USUARIO}/${REPO}/contents/${tipoFolder}`,{
    headers:{"Authorization":"token "+GITHUB_TOKEN}
  }).then(r=>r.json());
  let num = (lista.filter(f=>f.name.includes(seleccionado.tipo==="movie"?"pelicula":"serie")).length)+1;
  let nombreGeneral = (seleccionado.tipo==="movie"?"pelicula":"serie")+num+".html";

  // 1) copia general
  await crearArchivoGit(`${tipoFolder}/${nombreGeneral}`, html);

  // 2) por género automático
  for(let genero of seleccionado.generos){
    let carpeta = `Categorias/${genero}`;
    // crear carpeta si no existe:
    await fetch(`https://api.github.com/repos/${USUARIO}/${REPO}/contents/${carpeta}`,{
      method:"GET",
      headers:{"Authorization":"token "+GITHUB_TOKEN}
    }).then(async r=>{
      if(r.status==404){
        // crear carpeta
        await crearArchivoGit(`${carpeta}/.gitkeep`,"");
      }
    });
    await crearArchivoGit(`${carpeta}/${nombreGeneral}`, html);
  }
  alert("Publicado correctamente "+nombreGeneral);
  cerrarModal();
});
</script>
</body>
</html>
